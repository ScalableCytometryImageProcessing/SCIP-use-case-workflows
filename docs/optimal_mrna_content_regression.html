---

title: Finding the optimal model for mRNA content regression using Optuna

keywords: fastai
sidebar: home_sidebar

summary: "API details."
description: "API details."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/4c_optimal_mrna_content_regression.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;module &#39;ehv.core&#39; from &#39;/home/maximl/Data/dev/active/EhV-analysis/ehv/core.py&#39;&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">core</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="s2">&quot;../config_cn1346.yml&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">meta</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">fcsparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">FCS_NONINTENSITY</span><span class="p">)</span>
<span class="n">df_meta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;timepoint&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_meta</span><span class="p">[</span><span class="s2">&quot;timepoint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_meta</span><span class="p">[</span><span class="s2">&quot;timepoint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;timepoint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="n">a</span><span class="p">])</span>
<span class="n">df_meta</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_meta</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="n">a</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;replicate&quot;</span><span class="p">,</span> <span class="s2">&quot;timepoint&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">fluor_df</span> <span class="o">=</span> <span class="n">fcsparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">FCS_FLUOR</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metric_funcs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">explained_variance_score</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">max_error</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">mean_absolute_error</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">median_absolute_error</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">r2_score</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="BF-regression-on-targets">BF regression on targets<a class="anchor-link" href="#BF-regression-on-targets"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bf_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;(i?).*BF.*&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Prepare-folds">Prepare folds<a class="anchor-link" href="#Prepare-folds"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">outer_fold</span><span class="p">,</span> <span class="n">inner_folds</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">FOLDS</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="standardizer" class="doc_header"><code>standardizer</code><a href="https://github.com/mlippeve/ehv/tree/master/ehv/mrna_content_regression.py#L42" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>standardizer</code>(<strong><code>X</code></strong>, <strong><code>mean</code></strong>, <strong><code>std</code></strong>=<em><code>1.0</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="preprocess_funcs" class="doc_header"><code>preprocess_funcs</code><a href="https://github.com/mlippeve/ehv/tree/master/ehv/mrna_content_regression.py#L47" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>preprocess_funcs</code>(<strong><code>df</code></strong>, <strong><code>target</code></strong>, <strong><code>outer_fold</code></strong>, <strong><code>inner_folds</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bf_tmr_funcs</span> <span class="o">=</span> <span class="n">preprocess_funcs</span><span class="p">(</span><span class="n">bf_df</span><span class="p">,</span> <span class="n">fluor_df</span><span class="p">[</span><span class="s2">&quot;IntensityMCTMRlogicle&quot;</span><span class="p">],</span> <span class="n">outer_fold</span><span class="p">,</span> <span class="n">inner_folds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Hyper-parameter-experiment">Hyper-parameter experiment<a class="anchor-link" href="#Hyper-parameter-experiment"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="define_dummy" class="doc_header"><code>define_dummy</code><a href="https://github.com/mlippeve/ehv/tree/master/ehv/mrna_content_regression.py#L82" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>define_dummy</code>(<strong><code>trial</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="define_mlp" class="doc_header"><code>define_mlp</code><a href="https://github.com/mlippeve/ehv/tree/master/ehv/mrna_content_regression.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>define_mlp</code>(<strong><code>trial</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="define_xgb" class="doc_header"><code>define_xgb</code><a href="https://github.com/mlippeve/ehv/tree/master/ehv/mrna_content_regression.py#L98" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>define_xgb</code>(<strong><code>trial</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="define_sgd" class="doc_header"><code>define_sgd</code><a href="https://github.com/mlippeve/ehv/tree/master/ehv/mrna_content_regression.py#L108" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>define_sgd</code>(<strong><code>trial</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="objective" class="doc_header"><code>objective</code><a href="https://github.com/mlippeve/ehv/tree/master/ehv/mrna_content_regression.py#L132" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>objective</code>(<strong><code>trial</code></strong>, <strong><code>inner_fold</code></strong>, <strong><code>funcs</code></strong>, <strong><code>X</code></strong>, <strong><code>y</code></strong>, <strong><code>model_names</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nested_cross_validation_with_hyperparam_optimization" class="doc_header"><code>nested_cross_validation_with_hyperparam_optimization</code><a href="https://github.com/mlippeve/ehv/tree/master/ehv/mrna_content_regression.py#L158" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nested_cross_validation_with_hyperparam_optimization</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>target</code></strong>:<code>Series</code>, <strong><code>model_names</code></strong>:<code>str</code>, <strong><code>optuna_storage</code></strong>:<code>str</code>, <strong><code>optuna_n_trials</code></strong>:<code>int</code>, <strong><code>optuna_study_name_fmt</code></strong>:<code>str</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">nested_cross_validation_with_hyperparam_optimization</span><span class="p">(</span>
    <span class="n">bf_df</span><span class="p">,</span> <span class="n">fluor_df</span><span class="p">[</span><span class="s2">&quot;IntensityMCTMRlogicle&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;xgb&quot;</span><span class="p">],</span> <span class="s2">&quot;sqlite:///tmp/test.sqlite&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;test_run_2_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:__main__:Hyper param tuning on outer fold 0, inner fold repeat 1/3
[I 2020-08-26 18:38:11,336] Using an existing study with name &#39;test_run_2_0_0&#39; instead of creating a new one.
INFO:__main__:[&#39;xgb&#39;]
INFO:__main__:Fitting model on inner fold 0
INFO:__main__:Fitting model on inner fold 1
INFO:__main__:Fitting model on inner fold 2
[I 2020-08-26 18:39:03,598] Trial 1 finished with value: 0.1596449762582779 and parameters: {&#39;model_name&#39;: &#39;xgb&#39;, &#39;n_estimators&#39;: 237, &#39;max_depth&#39;: 9, &#39;learning_rate&#39;: 0.001391080006585426, &#39;subsample&#39;: 0.5616181033132915}. Best is trial 1 with value: 0.1596449762582779.
INFO:__main__:[&#39;xgb&#39;]
INFO:__main__:Fitting model on inner fold 0
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-53-dc3abfbc686e&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> scores = nested_cross_validation_with_hyperparam_optimization(
</span><span class="ansi-green-intense-fg ansi-bold">      2</span>     bf_df<span class="ansi-blue-fg">,</span> fluor_df<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#34;IntensityMCTMRlogicle&#34;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span>     <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#34;xgb&#34;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;sqlite:///tmp/test.sqlite&#34;</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;test_run_2_%d_%d&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span> )

<span class="ansi-green-fg">&lt;ipython-input-48-e68542f5e1e0&gt;</span> in <span class="ansi-cyan-fg">nested_cross_validation_with_hyperparam_optimization</span><span class="ansi-blue-fg">(df, target, model_names, optuna_storage, optuna_n_trials, optuna_study_name_fmt)</span>
<span class="ansi-green-intense-fg ansi-bold">     25</span>             study <span class="ansi-blue-fg">=</span> optuna<span class="ansi-blue-fg">.</span>create_study<span class="ansi-blue-fg">(</span>study_name<span class="ansi-blue-fg">=</span>optuna_study_name_fmt <span class="ansi-blue-fg">%</span> <span class="ansi-blue-fg">(</span>i<span class="ansi-blue-fg">,</span> j<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> direction<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;minimize&#39;</span><span class="ansi-blue-fg">,</span> storage<span class="ansi-blue-fg">=</span>optuna_storage<span class="ansi-blue-fg">,</span> load_if_exists<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     26</span>             study<span class="ansi-blue-fg">.</span>set_user_attr<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;cross-validation splits&#34;</span><span class="ansi-blue-fg">,</span> core<span class="ansi-blue-fg">.</span>FOLDS<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 27</span><span class="ansi-red-fg">             </span>study<span class="ansi-blue-fg">.</span>optimize<span class="ansi-blue-fg">(</span>fold_objective<span class="ansi-blue-fg">,</span> n_trials<span class="ansi-blue-fg">=</span>optuna_n_trials<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     28</span> 
<span class="ansi-green-intense-fg ansi-bold">     29</span>             logging<span class="ansi-blue-fg">.</span>getLogger<span class="ansi-blue-fg">(</span>__name__<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>info<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#34;Retraining on outer fold {i}, inner fold repeat {j+1}/{len(inner_folds)}&#34;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.conda/envs/ml/lib/python3.8/site-packages/optuna/study.py</span> in <span class="ansi-cyan-fg">optimize</span><span class="ansi-blue-fg">(self, func, n_trials, timeout, n_jobs, catch, callbacks, gc_after_trial, show_progress_bar)</span>
<span class="ansi-green-intense-fg ansi-bold">    289</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    290</span>             <span class="ansi-green-fg">if</span> n_jobs <span class="ansi-blue-fg">==</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 291</span><span class="ansi-red-fg">                 self._optimize_sequential(
</span><span class="ansi-green-intense-fg ansi-bold">    292</span>                     func<span class="ansi-blue-fg">,</span> n_trials<span class="ansi-blue-fg">,</span> timeout<span class="ansi-blue-fg">,</span> catch<span class="ansi-blue-fg">,</span> callbacks<span class="ansi-blue-fg">,</span> gc_after_trial<span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span>
<span class="ansi-green-intense-fg ansi-bold">    293</span>                 )

<span class="ansi-green-fg">~/.conda/envs/ml/lib/python3.8/site-packages/optuna/study.py</span> in <span class="ansi-cyan-fg">_optimize_sequential</span><span class="ansi-blue-fg">(self, func, n_trials, timeout, catch, callbacks, gc_after_trial, time_start)</span>
<span class="ansi-green-intense-fg ansi-bold">    652</span>                     <span class="ansi-green-fg">break</span>
<span class="ansi-green-intense-fg ansi-bold">    653</span> 
<span class="ansi-green-fg">--&gt; 654</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_run_trial_and_callbacks<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> catch<span class="ansi-blue-fg">,</span> callbacks<span class="ansi-blue-fg">,</span> gc_after_trial<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    655</span> 
<span class="ansi-green-intense-fg ansi-bold">    656</span>             self<span class="ansi-blue-fg">.</span>_progress_bar<span class="ansi-blue-fg">.</span>update<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>datetime<span class="ansi-blue-fg">.</span>datetime<span class="ansi-blue-fg">.</span>now<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-</span> time_start<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>total_seconds<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.conda/envs/ml/lib/python3.8/site-packages/optuna/study.py</span> in <span class="ansi-cyan-fg">_run_trial_and_callbacks</span><span class="ansi-blue-fg">(self, func, catch, callbacks, gc_after_trial)</span>
<span class="ansi-green-intense-fg ansi-bold">    683</span>         <span class="ansi-red-fg"># type: (...) -&gt; None</span>
<span class="ansi-green-intense-fg ansi-bold">    684</span> 
<span class="ansi-green-fg">--&gt; 685</span><span class="ansi-red-fg">         </span>trial <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_run_trial<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> catch<span class="ansi-blue-fg">,</span> gc_after_trial<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    686</span>         <span class="ansi-green-fg">if</span> callbacks <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    687</span>             frozen_trial <span class="ansi-blue-fg">=</span> copy<span class="ansi-blue-fg">.</span>deepcopy<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_storage<span class="ansi-blue-fg">.</span>get_trial<span class="ansi-blue-fg">(</span>trial<span class="ansi-blue-fg">.</span>_trial_id<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.conda/envs/ml/lib/python3.8/site-packages/optuna/study.py</span> in <span class="ansi-cyan-fg">_run_trial</span><span class="ansi-blue-fg">(self, func, catch, gc_after_trial)</span>
<span class="ansi-green-intense-fg ansi-bold">    707</span> 
<span class="ansi-green-intense-fg ansi-bold">    708</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 709</span><span class="ansi-red-fg">             </span>result <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">(</span>trial<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    710</span>         <span class="ansi-green-fg">except</span> exceptions<span class="ansi-blue-fg">.</span>TrialPruned <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    711</span>             message <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&#34;Trial {} pruned. {}&#34;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>trial_number<span class="ansi-blue-fg">,</span> str<span class="ansi-blue-fg">(</span>e<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-47-77c86cefa279&gt;</span> in <span class="ansi-cyan-fg">objective</span><span class="ansi-blue-fg">(trial, inner_fold, funcs, X, y, model_names)</span>
<span class="ansi-green-intense-fg ansi-bold">     15</span>         y_train <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>y<span class="ansi-blue-fg">.</span>iloc<span class="ansi-blue-fg">[</span>train_idx<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     16</span> 
<span class="ansi-green-fg">---&gt; 17</span><span class="ansi-red-fg">         </span>model<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>X_train<span class="ansi-blue-fg">,</span> y_train<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     18</span> 
<span class="ansi-green-intense-fg ansi-bold">     19</span>         X_val <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>X<span class="ansi-blue-fg">.</span>iloc<span class="ansi-blue-fg">[</span>val_idx<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.conda/envs/ml/lib/python3.8/site-packages/xgboost/sklearn.py</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(self, X, y, sample_weight, base_margin, eval_set, eval_metric, early_stopping_rounds, verbose, xgb_model, sample_weight_eval_set, callbacks)</span>
<span class="ansi-green-intense-fg ansi-bold">    542</span>                 params<span class="ansi-blue-fg">.</span>update<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">{</span><span class="ansi-blue-fg">&#39;eval_metric&#39;</span><span class="ansi-blue-fg">:</span> eval_metric<span class="ansi-blue-fg">}</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    543</span> 
<span class="ansi-green-fg">--&gt; 544</span><span class="ansi-red-fg">         self._Booster = train(params, train_dmatrix,
</span><span class="ansi-green-intense-fg ansi-bold">    545</span>                               self<span class="ansi-blue-fg">.</span>get_num_boosting_rounds<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> evals<span class="ansi-blue-fg">=</span>evals<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    546</span>                               early_stopping_rounds<span class="ansi-blue-fg">=</span>early_stopping_rounds<span class="ansi-blue-fg">,</span>

<span class="ansi-green-fg">~/.conda/envs/ml/lib/python3.8/site-packages/xgboost/training.py</span> in <span class="ansi-cyan-fg">train</span><span class="ansi-blue-fg">(params, dtrain, num_boost_round, evals, obj, feval, maximize, early_stopping_rounds, evals_result, verbose_eval, xgb_model, callbacks)</span>
<span class="ansi-green-intense-fg ansi-bold">    203</span>         callbacks<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>callback<span class="ansi-blue-fg">.</span>record_evaluation<span class="ansi-blue-fg">(</span>evals_result<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    204</span> 
<span class="ansi-green-fg">--&gt; 205</span><span class="ansi-red-fg">     return _train_internal(params, dtrain,
</span><span class="ansi-green-intense-fg ansi-bold">    206</span>                            num_boost_round<span class="ansi-blue-fg">=</span>num_boost_round<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    207</span>                            evals<span class="ansi-blue-fg">=</span>evals<span class="ansi-blue-fg">,</span>

<span class="ansi-green-fg">~/.conda/envs/ml/lib/python3.8/site-packages/xgboost/training.py</span> in <span class="ansi-cyan-fg">_train_internal</span><span class="ansi-blue-fg">(params, dtrain, num_boost_round, evals, obj, feval, xgb_model, callbacks)</span>
<span class="ansi-green-intense-fg ansi-bold">     72</span>         <span class="ansi-red-fg"># Skip the first update if it is a recovery step.</span>
<span class="ansi-green-intense-fg ansi-bold">     73</span>         <span class="ansi-green-fg">if</span> version <span class="ansi-blue-fg">%</span> <span class="ansi-cyan-fg">2</span> <span class="ansi-blue-fg">==</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 74</span><span class="ansi-red-fg">             </span>bst<span class="ansi-blue-fg">.</span>update<span class="ansi-blue-fg">(</span>dtrain<span class="ansi-blue-fg">,</span> i<span class="ansi-blue-fg">,</span> obj<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     75</span>             bst<span class="ansi-blue-fg">.</span>save_rabit_checkpoint<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     76</span>             version <span class="ansi-blue-fg">+=</span> <span class="ansi-cyan-fg">1</span>

<span class="ansi-green-fg">~/.conda/envs/ml/lib/python3.8/site-packages/xgboost/core.py</span> in <span class="ansi-cyan-fg">update</span><span class="ansi-blue-fg">(self, dtrain, iteration, fobj)</span>
<span class="ansi-green-intense-fg ansi-bold">   1245</span> 
<span class="ansi-green-intense-fg ansi-bold">   1246</span>         <span class="ansi-green-fg">if</span> fobj <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1247</span><span class="ansi-red-fg">             _check_call(_LIB.XGBoosterUpdateOneIter(self.handle,
</span><span class="ansi-green-intense-fg ansi-bold">   1248</span>                                                     ctypes<span class="ansi-blue-fg">.</span>c_int<span class="ansi-blue-fg">(</span>iteration<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">   1249</span>                                                     dtrain.handle))

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<Command nested-cross-validation-with-hyperparam-optimization-command>" class="doc_header"><code><Command nested-cross-validation-with-hyperparam-optimization-command></code><a href="" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code><Command nested-cross-validation-with-hyperparam-optimization-command></code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

